{% extends "base.html" %}
{% block content %}
<h2>Edited config name: {{ cfg.name }}</h2>

<form method="post" class="form">
    <h3>Active Models</h3>
    <div class="grid active-models">
        {% for fam, models in families.items() %}
        <div class="panel">
            <h4>{{ fam }}</h4
            ><select name="{{ fam }}[]" multiple size="6" class="w100">
            {% for m in models %}
            <option value="{{ m.name }}" {% if m.name in actives[fam] %}selected{% endif %}>{{ m.name }}</option>
            {% endfor %}
        </select>
        </div>
        {% endfor %}
    </div>
    <label>Changelog (optional)
        <input type="text" name="note" placeholder="np. zmiana wag, dodanie providera">
    </label>
    <div class="form-actions">
        <button class="btn" type="submit">Save changes</button>
        <a class="btn btn-secondary" href="{{ url_for('view_config', config_id=cfg.id) }}">Preview</a>
    </div>
</form>

<hr>

<h3>Models and providers</h3>

<div class="grid">
    {% for fam, models in families.items() %}
    <section class="panel">
        <div class="panel-header">
            <h4>{{ fam }}</h4>
            <form hx-post="{{ url_for('add_model', config_id=cfg.id) }}" hx-trigger="submit"
                  hx-swap="none"
                  hx-on="htmx:afterRequest: location.reload()"
                  class="add-model-form">
                <input type="hidden" name="family" value="{{ fam }}">
                <input type="text" name="name"
                       placeholder="Model name (f.e. google/gemma-3-12b-it)" required>
                <button class="btn btn-small" type="submit">Add model</button>
            </form>
        </div>
        <hr class="model-separator">
        {% for m in models %}
        <details class="model">
            <summary>
                <strong>{{ m.name }}</strong>
                <button class="btn btn-small danger"
                        hx-post="{{ url_for('delete_model', model_id=m.id) }}"
                        hx-swap="none"
                        hx-on="htmx:afterRequest: location.reload()"
                        onclick="return confirm('Are you sure to delete {{ m.name }}?')">Delete
                </button>
            </summary>

            <div class="scroll-wrap">
                <table class="table compact">
                    <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-host">Host</th>
                        <th class="col-api">API</th>
                        <th class="col-input">Input</th>
                        <th class="col-path">Model path</th>
                        <th class="col-weight">Weight</th>
                        <th class="col-token">Token</th>
                        <th class="col-enabled">Is active</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for p in m.providers %}
                    <tr x-data="{ masked: true }">
                        <td class="col-id">
                            <input value="{{ p.provider_id }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                         {method:'POST',headers:{'Content-Type':'application/json'},
                          body:JSON.stringify({provider_id:$event.target.value})})">
                        </td>
                        <td class="col-host">
                            <input value="{{ p.api_host }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                         {method:'POST',headers:{'Content-Type':'application/json'},
                          body:JSON.stringify({api_host:$event.target.value})})">
                        </td>
                        <td class="col-api">
                            <select
                                    @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                        {method:'POST',headers:{'Content-Type':'application/json'},
                         body:JSON.stringify({api_type:$event.target.value})})">
                                {% for t in ['vllm','openai','ollama'] %}
                                <option value="{{ t }}" {% if p.api_type== t %}selected{% endif %}>{{ t }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="col-input">
                            <input type="number" min="1" value="{{ p.input_size }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                         {method:'POST',headers:{'Content-Type':'application/json'},
                          body:JSON.stringify({input_size:parseInt($event.target.value)})})">
                        </td>
                        <td class="col-path">
                            <input value="{{ p.model_path or '' }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                         {method:'POST',headers:{'Content-Type':'application/json'},
                          body:JSON.stringify({model_path:$event.target.value})})">
                        </td>
                        <td class="col-weight">
                            <input type="number" step="0.01" min="0" max="1" value="{{ '%.2f'|format(p.weight) }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                         {method:'POST',headers:{'Content-Type':'application/json'},
                          body:JSON.stringify({weight:parseFloat($event.target.value)})})">
                        </td>
                        <td class="col-token">
                            <div class="token-field">
                                <input :type="masked ? 'password' : 'text'" value="{{ p.api_token }}"
                                       @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                               {method:'POST',headers:{'Content-Type':'application/json'},
                                body:JSON.stringify({api_token:$event.target.value})})">
                                <button class="btn btn-small" type="button"
                                        @click="masked = !masked"
                                        x-text="masked ? 'Show' : 'Hide'">
                                </button>
                            </div>
                        </td>
                        <td class="col-enabled">
                            <input type="checkbox" {% if p.enabled %}checked{% endif %}
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                         {method:'POST',headers:{'Content-Type':'application/json'},
                          body:JSON.stringify({enabled:$event.target.checked})})">
                        </td>
                        <td class="col-actions nowrap">
                            <button class="btn btn-small danger"
                                    hx-post="{{ url_for('delete_provider', provider_id=p.id) }}"
                                    hx-swap="none"
                                    hx-on="htmx:afterRequest: location.reload()"
                                    onclick="return confirm('Are you sure to delete this provider?')">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="muted">No providers found.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <details>
                <summary class="clickable" style="cursor:pointer;">&#x2795; Add model provider</summary>
                <form class="add-model-form" style="width:100%" onsubmit="return addProvider{{ m.id }}(event)">
                    <input type="text" placeholder="Provider ID" id="pid-{{ m.id }}" required>
                    <input type="url" placeholder="API host (e.g. https://api.example.com)" id="phost-{{ m.id }}"
                           required>
                    <!-- Button to test if the host is reachable -->
                    <button type="button" class="btn btn-small" onclick="checkHost{{ m.id }}()">Check</button>
                    <!-- Inline status message -->
                    <span id="host-status-{{ m.id }}" class="muted" style="margin-left:8px;"></span>
                    <select id="ptype-{{ m.id }}">
                        <option value="vllm">vllm</option>
                        <option value="openai">openai</option>
                        <option value="ollama">ollama</option>
                    </select>
                    <input type="number" placeholder="Input size" id="psize-{{ m.id }}" value="4096" min="1">
                    <input type="text" placeholder="Model path (optional)" id="ppath-{{ m.id }}">
                    <input type="number" step="0.01" min="0" max="1" placeholder="Weight (0‑1)" id="pweight-{{ m.id }}"
                           value="1.0">
                    <input type="text" placeholder="API token (optional)" id="ptoken-{{ m.id }}">
                    <label class="chk"><input type="checkbox" id="penabled-{{ m.id }}" checked> enabled</label>
                    <button class="btn btn-small" type="submit">Add</button>
                </form>
                <script>
                    async function addProvider{{ m.id }}(e){
                      e.preventDefault();
                      const payload = {
                        id: document.getElementById('pid-{{ m.id }}').value,
                        api_host: document.getElementById('phost-{{ m.id }}').value,
                        api_type: document.getElementById('ptype-{{ m.id }}').value,
                        input_size: parseInt(document.getElementById('psize-{{ m.id }}').value || "4096"),
                        model_path: document.getElementById('ppath-{{ m.id }}').value,
                        weight: parseFloat(document.getElementById('pweight-{{ m.id }}').value || "1.0"),
                        api_token: document.getElementById('ptoken-{{ m.id }}').value,
                        enabled: document.getElementById('penabled-{{ m.id }}').checked
                      };
                      const res = await fetch('{{ url_for("add_provider", model_id=m.id) }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                      });
                      if(res.ok){ location.reload(); } else { alert("Error while adding provider"); }
                    }

                    // -------------------------------------------------
                    // Check host availability via server‑side proxy.
                    // -------------------------------------------------
                    async function checkHost{{ m.id }}(){
                        const host = document.getElementById('phost-{{ m.id }}').value;
                        const statusEl = document.getElementById('host-status-{{ m.id }}');

                        if (!host) {
                            statusEl.textContent = 'Please enter a host URL first.';
                            statusEl.style.color = 'var(--danger)';
                            return;
                        }

                        statusEl.textContent = 'Checking...';
                        statusEl.style.color = 'var(--muted)';

                        try {
                            const resp = await fetch('{{ url_for("check_host") }}', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: host })
                            });

                            const data = await resp.json();

                            // The proxy returns {status: xxx} on success
                            if (resp.ok && typeof data.status === 'number') {
                                const code = data.status;
                                if (code >= 500) {
                                    statusEl.textContent = `${code}`;
                                    statusEl.style.color = 'var(--ok)';
                                } else if (code === 404) {
                                    statusEl.textContent = '${code}';
                                    statusEl.style.color = 'var(--danger)';
                                } else if (code >= 200 && code < 400) {
                                    statusEl.textContent = `OK!`;
                                    statusEl.style.color = 'var(--ok)';
                                } else {
                                    statusEl.textContent = `Host responded with status ${code}.`;
                                    statusEl.style.color = 'var(--danger)';
                                }
                            } else {
                                // Any error from the proxy (e.g., network timeout)
                                const errMsg = data.error || 'Unable to reach the host.';
                                statusEl.textContent = errMsg;
                                statusEl.style.color = 'var(--danger)';
                            }
                        } catch (e) {
                            console.error(e);
                            statusEl.textContent = 'Unable to reach the host. Check the URL or server connectivity.';
                            statusEl.style.color = 'var(--danger)';
                        }
                    }
                </script>
            </details>
        </details>
        <hr class="model-divider">
        {% else %}
        <p class="muted">No models found.</p>
        {% endfor %}
    </section>
    {% endfor %}
</div>

<div class="actions">
    <a class="btn" href="{{ url_for('export_config', config_id=cfg.id) }}">Export config</a>
    <button class="btn" hx-post="{{ url_for('set_active_config', config_id=cfg.id) }}" hx-swap="none">Set as default
    </button>
    <a class="btn btn-secondary" href="{{ url_for('view_config', config_id=cfg.id) }}">Preview</a>
</div>

<hr>

<h3>History</h3>

<div id="history-wrapper">
    <!-- HTMX fetches the JSON list of versions -->
    <div hx-get="{{ url_for('list_versions', config_id=cfg.id) }}"
         hx-trigger="load"
         hx-target="#versions"
         hx-swap="innerHTML">
    </div>
    <table class="table" id="versions"></table>
</div>

<button class="btn btn-small history-toggle" id="toggle-history" style="display:none;">
    Show full history
</button>

<script>
    /* After HTMX loads the JSON, build a table, then hide all rows except the newest.
       The toggle button shows / hides the rest of the history. */
    document.body.addEventListener('htmx:afterOnLoad', function (e) {
        if (!e.detail.target || e.detail.target.id !== 'versions') return;

        // 1️⃣ Parse JSON returned by /configs/<id>/versions
        let data;
        try {
            data = JSON.parse(e.detail.xhr.responseText);
        } catch (err) {
            console.error('Failed to parse versions JSON', err);
            return;
        }

        // 2️⃣ Build the table markup
        const rows = data.map(v => `
            <tr>
                <td>v${v.version}</td>
                <td>${new Date(v.created_at).toLocaleString()}</td>
                <td>${v.note || ''}</td>
                <td></td>
            </tr>`).join('');

        e.detail.target.innerHTML = `
            <thead>
                <tr>
                    <th>Version</th>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>`;

        // 3️⃣ Hide all rows except the first (newest)
        const tbody = e.detail.target.querySelector('tbody');
        const trList = tbody.querySelectorAll('tr');

        const btn = document.getElementById('toggle-history');

        if (trList.length <= 1) {
            // only one entry – no need for a toggle button
            btn.style.display = 'none';
            return;
        }

        // hide older rows
        for (let i = 1; i < trList.length; i++) {
            trList[i].style.display = 'none';
        }

        // show the toggle button
        btn.style.display = 'inline-block';
        btn.textContent = 'Show full history';

        // toggle handler
        btn.onclick = function () {
            const showAll = btn.textContent.startsWith('Show');
            for (let i = 1; i < trList.length; i++) {
                trList[i].style.display = showAll ? '' : 'none';
            }
            btn.textContent = showAll ? 'Hide history' : 'Show full history';
        };
    });
</script>

{% endblock %}